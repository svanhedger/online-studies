<!DOCTYPE html>
<html>
  <head>
    <title>Auditory Memory</title>
    <script src="jspsych-6.0.1/jspsych.js"></script>
    <script src="jspsych-6.0.1/plugins/jspsych-audio-keyboard-response.js"></script>
    <script src="jspsych-6.0.1/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="jspsych-6.0.1/plugins/jspsych-image-keyboard-response.js"></script>
    <script src="jspsych-6.0.1/plugins/jspsych-html-button-response.js"></script>
	  <script src="jspsych-6.0.1/plugins/jspsych-fullscreen.js"></script>
	  <script src="jspsych-6.0.1/plugins/jspsych-external-html.js"></script>
	  <script src="jspsych-6.0.2/plugins/jspsych-survey-text.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <link href="jspsych-6.0.1/css/jspsych.css" rel="stylesheet" type="text/css"></link>
  </head>
  <body>


<script>

/** Add random subject ID to script **/
var identifier = Math.random().toString(36).substring(7);
jsPsych.data.addProperties({subject: identifier});


/** define the timeline variable **/
var timeline = [];

/*************/
/** CONSENT **/
/*************/

/** present consent as a separate html file, must agree and click on 'start' button to continue **/

var consent_trial = {
  type:"external-html",
  url: "consent15.html", //file should be in same location as this script
  cont_btn: "start"
};

/** push the consent screen to the timeline **/
timeline.push(consent_trial);



/******************/
/** INTRODUCTION **/
/******************/

/** introduction screen **/
var welcome = {
  type: "html-keyboard-response",
  stimulus: "Welcome.</p> This experiment runs in fullscreen mode. To enter fullscreen mode, press any key."
};

/** push the introduction screen to the timeline **/
timeline.push(welcome);

/** push the fullscreen component to the experiment **/
timeline.push({
  type: 'fullscreen',
  fullscreen_mode: true
});

/** instruction(s) -- html-keyboard-response makes it so that you can use html to control presentation **/
var instructions = {
  type: "html-keyboard-response",
  stimulus: "<p>In this experiment, you will hear several popular music recordings </p><p>" +
      "On each trial, you will hear two versions of each recording. One of the recordings will be 'incorrect,' in that it will be played 'too high' or 'too low'" +
	  "<p>relative to the correct version. Your job is to determine which version is correct. <p></p>(Press SPACEBAR to continue.)",
  choices: [' '],
  post_trial_gap: 250
};

var instructions2 = {
  type: "html-keyboard-response",
  stimulus: "<p>However, there's a small catch. The recordings have been 'thin sliced,' meaning they are EXTREMELY short.</p>" +
		    "<p>Each one is only one-quarter of one second (250 milliseconds) long. " +
			"<p>Even though these 'thin slices' are short, they are taken from a recognizable moment of the recording.</p>" +
			"<p>If you are ever unsure of which version is correct, please make your best guess.</p><p>(Press SPACEBAR to begin.)</p>",
  choices: [' '],
  post_trial_gap: 1000
};

/** push the instruction(s) to the timeline **/
timeline.push(instructions);
timeline.push(instructions2);

/*************/
/** STIMULI **/
/*************/

/** define the stimuli for preloading **/

var audio = ["thinsliced/01_0.mp3", "thinsliced/01_1.mp3", "thinsliced/01_-1.mp3", "thinsliced/02_0.mp3", "thinsliced/02_1.mp3", "thinsliced/02_-1.mp3",
"thinsliced/03_0.mp3", "thinsliced/03_1.mp3", "thinsliced/03_-1.mp3", "thinsliced/04_0.mp3", "thinsliced/04_1.mp3", "thinsliced/04_-1.mp3", 
"thinsliced/05_0.mp3", "thinsliced/05_1.mp3", "thinsliced/05_-1.mp3", "thinsliced/06_0.mp3", "thinsliced/06_1.mp3", "thinsliced/06_-1.mp3", 
"thinsliced/07_0.mp3", "thinsliced/07_1.mp3", "thinsliced/07_-1.mp3", "thinsliced/08_0.mp3", "thinsliced/08_1.mp3", "thinsliced/08_-1.mp3",
"thinsliced/09_0.mp3", "thinsliced/09_1.mp3", "thinsliced/09_-1.mp3", "thinsliced/10_0.mp3", "thinsliced/10_1.mp3", "thinsliced/10_-1.mp3",
"thinsliced/11_0.mp3", "thinsliced/11_1.mp3", "thinsliced/11_-1.mp3", "thinsliced/12_0.mp3", "thinsliced/12_1.mp3", "thinsliced/12_-1.mp3",
"thinsliced/13_0.mp3", "thinsliced/13_1.mp3", "thinsliced/13_-1.mp3", "thinsliced/14_0.mp3", "thinsliced/14_1.mp3", "thinsliced/14_-1.mp3",
"thinsliced/15_0.mp3", "thinsliced/15_1.mp3", "thinsliced/15_-1.mp3", "thinsliced/16_0.mp3", "thinsliced/16_1.mp3", "thinsliced/16_-1.mp3",
"thinsliced/17_0.mp3", "thinsliced/17_1.mp3", "thinsliced/17_-1.mp3", "thinsliced/18_0.mp3", "thinsliced/18_1.mp3", "thinsliced/18_-1.mp3",
"thinsliced/19_0.mp3", "thinsliced/19_1.mp3", "thinsliced/19_-1.mp3", "thinsliced/20_0.mp3", "thinsliced/20_1.mp3", "thinsliced/20_-1.mp3"];

/** define the variables for the procedure timeline (similar to how you would make a list in eprime) **/

var sounds = [
{intune: "thinsliced/01_0.mp3", sharp: "thinsliced/01_1.mp3", flat: "thinsliced/01_-1.mp3", name: "Britney Spears' 'Baby One More Time'"},
{intune: "thinsliced/02_0.mp3", sharp: "thinsliced/02_1.mp3", flat: "thinsliced/02_-1.mp3", name: "Katy Perry's 'California Gurls'"},
{intune: "thinsliced/03_0.mp3", sharp: "thinsliced/03_1.mp3", flat: "thinsliced/03_-1.mp3", name: "Carly Rae Jepsen's 'Call Me Maybe'"},
{intune: "thinsliced/04_0.mp3", sharp: "thinsliced/04_1.mp3", flat: "thinsliced/04_-1.mp3", name: "Katy Perry's 'Firework'"},
{intune: "thinsliced/05_0.mp3", sharp: "thinsliced/05_1.mp3", flat: "thinsliced/05_-1.mp3", name: "Daft Punk's 'Get Lucky'"},
{intune: "thinsliced/06_0.mp3", sharp: "thinsliced/06_1.mp3", flat: "thinsliced/06_-1.mp3", name: "The Beatles' 'Hey Jude'"},
{intune: "thinsliced/07_0.mp3", sharp: "thinsliced/07_1.mp3", flat: "thinsliced/07_-1.mp3", name: "Britney Spears' 'Oops I Did It Again'"},
{intune: "thinsliced/08_0.mp3", sharp: "thinsliced/08_1.mp3", flat: "thinsliced/08_-1.mp3", name: "Lady Gaga's 'Poker Face'"},
{intune: "thinsliced/09_0.mp3", sharp: "thinsliced/09_1.mp3", flat: "thinsliced/09_-1.mp3", name: "Gotye's 'Somebody That I Used To Know'"},
{intune: "thinsliced/10_0.mp3", sharp: "thinsliced/10_1.mp3", flat: "thinsliced/10_-1.mp3", name: "Star Wars (Main Theme)"},
{intune: "thinsliced/11_0.mp3", sharp: "thinsliced/11_1.mp3", flat: "thinsliced/11_-1.mp3", name: "Queen's 'We Are the Champions'"},
{intune: "thinsliced/12_0.mp3", sharp: "thinsliced/12_1.mp3", flat: "thinsliced/12_-1.mp3", name: "Queen's 'We Will Rock You'"},
{intune: "thinsliced/13_0.mp3", sharp: "thinsliced/13_1.mp3", flat: "thinsliced/13_-1.mp3", name: "Katy Perry's 'Teenage Dream'"},
{intune: "thinsliced/14_0.mp3", sharp: "thinsliced/14_1.mp3", flat: "thinsliced/14_-1.mp3", name: "Lady Gaga's 'Telephone'"},
{intune: "thinsliced/15_0.mp3", sharp: "thinsliced/15_1.mp3", flat: "thinsliced/15_-1.mp3", name: "2001: A Space Odyssey (Main Theme)"},
{intune: "thinsliced/16_0.mp3", sharp: "thinsliced/16_1.mp3", flat: "thinsliced/16_-1.mp3", name: "Harry Potter (Theme)"},
{intune: "thinsliced/17_0.mp3", sharp: "thinsliced/17_1.mp3", flat: "thinsliced/17_-1.mp3", name: "Mario Brothers (Theme)"},
{intune: "thinsliced/18_0.mp3", sharp: "thinsliced/18_1.mp3", flat: "thinsliced/18_-1.mp3", name: "Queen's 'Bohemian Rhapsody'"},
{intune: "thinsliced/19_0.mp3", sharp: "thinsliced/19_1.mp3", flat: "thinsliced/19_-1.mp3", name: "Psy's 'Gangnam Style'"},
{intune: "thinsliced/20_0.mp3", sharp: "thinsliced/20_1.mp3", flat: "thinsliced/20_-1.mp3", name: "Billy Joel's 'Piano Man'"}
];

/** RANDOMIZE the variable sounds. Then, assign each recording to its own variable. This will then be used for each of the 20 trials **/
/** NOTE: This is clunky but will ensure that each of the four trial types will be heard exactly 5 times, and that no stimulus will repeat **/

var soundsrandom = jsPsych.randomization.repeat(sounds, 1);

var sounds1 = soundsrandom.slice(0, 1);
var sounds2 = soundsrandom.slice(1, 2);
var sounds3 = soundsrandom.slice(2, 3);
var sounds4 = soundsrandom.slice(3, 4);
var sounds5 = soundsrandom.slice(4, 5);
var sounds6 = soundsrandom.slice(5, 6);
var sounds7 = soundsrandom.slice(6, 7);
var sounds8 = soundsrandom.slice(7, 8);
var sounds9 = soundsrandom.slice(8, 9);
var sounds10 = soundsrandom.slice(9, 10);
var sounds11 = soundsrandom.slice(10, 11);
var sounds12 = soundsrandom.slice(11, 12);
var sounds13 = soundsrandom.slice(12, 13);
var sounds14 = soundsrandom.slice(13, 14);
var sounds15 = soundsrandom.slice(14, 15);
var sounds16 = soundsrandom.slice(15, 16);
var sounds17 = soundsrandom.slice(16, 17);
var sounds18 = soundsrandom.slice(17, 18);
var sounds19 = soundsrandom.slice(18, 19);
var sounds20 = soundsrandom.slice(19, 20);


/*************/
/** TRIALS ***/
/*************/


/** fixation trial **/
var fixation = {
      type: 'html-keyboard-response',
      stimulus: '<div style="font-size:60px;">+</div>',
      choices: jsPsych.NO_KEYS,
      trial_duration: 1000
    };

/** trial to display song name **/	
var songname = {
          type: 'html-keyboard-response',
		  prompt: "<p></p><p></p>(Press SPACEBAR to continue)",
          stimulus: function(){ return "<p>You will now hear two versions of </p> "+jsPsych.timelineVariable('name', true); },
          choices: [' '],
		  post_trial_gap: 500
    };

	
/** trial to display number 1 **/	
var disp1 = {
      type: 'html-keyboard-response',
      stimulus: '<div style="font-size:80px;">1</div>',
      choices: jsPsych.NO_KEYS,
      trial_duration: 1000
    };

/** trial to display number 2 **/	
var disp2 = {
      type: 'html-keyboard-response',
      stimulus: '<div style="font-size:80px;">2</div>',
      choices: jsPsych.NO_KEYS,
      trial_duration: 1000
    };

/** trial to play correct version **/	
var aud_intune = {
      type: 'audio-keyboard-response',
      stimulus: jsPsych.timelineVariable('intune'),
      choices: jsPsych.NO_KEYS,
      trial_duration: 1000
    };

/** trial to play incorrect (flat) version **/	
var aud_flat = {
          type: 'audio-keyboard-response',
          stimulus: jsPsych.timelineVariable('flat'),
          choices: jsPsych.NO_KEYS,
          trial_duration: 1000
    };

/** trial to play incorrect (sharp) version **/	
var aud_sharp = {
          type: 'audio-keyboard-response',
          stimulus: jsPsych.timelineVariable('sharp'),
          choices: jsPsych.NO_KEYS,
          trial_duration: 1000,
    };


/** judgment trial (first or second version correct?) -- when first version is correct **/
var judgment_trial1 = {
		type: "html-button-response",
		stimulus: '',
		choices: ['First', 'Second'],
		prompt: '<p>Which version did you think was correct?</p>',
    on_finish: function(data){
    if(data.button_pressed == 0){
      data.correct = 1;
    } else {
      data.correct = 0;
    }
  }
	};

	
/** judgment trial (first or second version correct?) -- when second version is correct **/	
var judgment_trial2 = {
		type: "html-button-response",
		stimulus: '',
		choices: ['First', 'Second'],
		prompt: '<p>Which version did you think was correct?</p>',
    on_finish: function(data){
    if(data.button_pressed == 1){
      data.correct = 1;
    } else {
      data.correct = 0;
    }
  }
	};

	
/** familiarity trial (5-point scale) **/
var familiarity_trial = {
		type: "html-button-response",
		stimulus: '',
		choices: ['not at all', 'slightly', 'somewhat', 'moderately', 'extremely'],
		prompt: '<p>How familiar are you with this recording?</p>'
	};

/****************************************************************/


/*****************/
/** PROCEDURES ***/
/*****************/

/** flat/in-tune trials **/
var procedure_flatfirst1 = {
      timeline: [fixation, songname, disp1, aud_flat, fixation, disp2, aud_intune, judgment_trial2, familiarity_trial],
      timeline_variables: sounds1
    };


var procedure_flatfirst2 = {
      timeline: [fixation, songname, disp1, aud_flat, fixation, disp2, aud_intune, judgment_trial2, familiarity_trial],
      timeline_variables: sounds2
    };

var procedure_flatfirst3 = {
      timeline: [fixation, songname, disp1, aud_flat, fixation, disp2, aud_intune, judgment_trial2, familiarity_trial],
      timeline_variables: sounds3
    };

var procedure_flatfirst4 = {
      timeline: [fixation, songname, disp1, aud_flat, fixation, disp2, aud_intune, judgment_trial2, familiarity_trial],
      timeline_variables: sounds4
    };

var procedure_flatfirst5 = {
      timeline: [fixation, songname, disp1, aud_flat, fixation, disp2, aud_intune, judgment_trial2, familiarity_trial],
      timeline_variables: sounds5
    };

/****************************************************************/

/** sharp/in-tune trials **/
var procedure_sharpfirst1 = {
      timeline: [fixation, songname, disp1, aud_sharp, fixation, disp2, aud_intune, judgment_trial2, familiarity_trial],
      timeline_variables: sounds6
    };


var procedure_sharpfirst2 = {
      timeline: [fixation, songname, disp1, aud_sharp, fixation, disp2, aud_intune, judgment_trial2, familiarity_trial],
      timeline_variables: sounds7
    };

var procedure_sharpfirst3 = {
      timeline: [fixation, songname, disp1, aud_sharp, fixation, disp2, aud_intune, judgment_trial2, familiarity_trial],
      timeline_variables: sounds8
    };

var procedure_sharpfirst4 = {
      timeline: [fixation, songname, disp1, aud_sharp, fixation, disp2, aud_intune, judgment_trial2, familiarity_trial],
      timeline_variables: sounds9
    };

var procedure_sharpfirst5 = {
      timeline: [fixation, songname, disp1, aud_sharp, fixation, disp2, aud_intune, judgment_trial2, familiarity_trial],
      timeline_variables: sounds10
    };


/****************************************************************/

/** in-tune/flat trials **/
var procedure_flatsecond1 = {
      timeline: [fixation, songname, disp1, aud_intune, fixation, disp2, aud_flat, judgment_trial1, familiarity_trial],
      timeline_variables: sounds11
    };

var procedure_flatsecond2 = {
      timeline: [fixation, songname, disp1, aud_intune, fixation, disp2, aud_flat, judgment_trial1, familiarity_trial],
      timeline_variables: sounds12
    };

var procedure_flatsecond3 = {
      timeline: [fixation, songname, disp1, aud_intune, fixation, disp2, aud_flat, judgment_trial1, familiarity_trial],
      timeline_variables: sounds13
    };

var procedure_flatsecond4 = {
      timeline: [fixation, songname, disp1, aud_intune, fixation, disp2, aud_flat, judgment_trial1, familiarity_trial],
      timeline_variables: sounds14
    };

var procedure_flatsecond5 = {
      timeline: [fixation, songname, disp1, aud_intune, fixation, disp2, aud_flat, judgment_trial1, familiarity_trial],
      timeline_variables: sounds15
    };

/****************************************************************/

/** in-tune/sharp trials **/
var procedure_sharpsecond1 = {
      timeline: [fixation, songname, disp1, aud_intune, fixation, disp2, aud_sharp, judgment_trial1, familiarity_trial],
      timeline_variables: sounds16
    };


var procedure_sharpsecond2 = {
      timeline: [fixation, songname, disp1, aud_intune, fixation, disp2, aud_sharp,  judgment_trial1, familiarity_trial],
      timeline_variables: sounds17
    };

var procedure_sharpsecond3 = {
      timeline: [fixation, songname, disp1, aud_intune, fixation, disp2, aud_sharp,  judgment_trial1, familiarity_trial],
      timeline_variables: sounds18
    };

var procedure_sharpsecond4 = {
      timeline: [fixation, songname, disp1, aud_intune, fixation, disp2, aud_sharp,  judgment_trial1, familiarity_trial],
      timeline_variables: sounds19
    };

var procedure_sharpsecond5 = {
      timeline: [fixation, songname, disp1, aud_intune, fixation, disp2, aud_sharp,  judgment_trial1, familiarity_trial],
      timeline_variables: sounds20
    };


/****************************************************************/

/**********************************/
/** COMBINED PROCEDURES (BLOCK) ***/
/**********************************/

/** put all 20 trial procedures into a single array, then shuffle it **/
var trials = [procedure_flatfirst1,
				procedure_flatfirst2,
				procedure_flatfirst3,
				procedure_flatfirst4,
				procedure_flatfirst5,
				procedure_sharpfirst1,
				procedure_sharpfirst2,
				procedure_sharpfirst3,
				procedure_sharpfirst4,
				procedure_sharpfirst5,
				procedure_flatsecond1,
				procedure_flatsecond2,
				procedure_flatsecond3,
				procedure_flatsecond4,
				procedure_flatsecond5,
				procedure_sharpsecond1,
				procedure_sharpsecond2,
				procedure_sharpsecond3,
				procedure_sharpsecond4,
				procedure_sharpsecond5];


var shuffled_trials = jsPsych.randomization.shuffle(trials); //

/** define the block **/
var block_structure = {
  timeline: shuffled_trials

};

timeline.push(block_structure);

/*******************/
/** Questionnaire **/
/*******************/

var interim = {
  type: "html-keyboard-response",
  stimulus: "Thank you for your responses. Press any key to continue."

};

timeline.push(interim);

var questionnaireD = {
  type: 'survey-text',
  questions: [{prompt: "How old are you (in years)?"}, {prompt: "What is your gender?"} ],
  preamble: ['Please answer the following questions to the best of your ability.']
};

timeline.push(questionnaireD);

var questionnaireM = {
  type: 'survey-text',
  questions: [{prompt: 'Have you ever played a musical instrument, including vocal training? (Y/N)'}, 
			  {prompt: 'How many years have you played your primary instrument?<p> If you do not play an instrument / have voice training, please type 0.'}, 
			  {prompt: 'At what age (in years) did you first begin musical instruction?<p> If you do not have any musical instruction, you may leave this question blank.'}, 
			  {prompt: 'Do you have absolute/perfect pitch? (Y/N)'}],
  preamble: ['Please answer the following questions to the best of your ability.'], 
  on_finish: function () {
          var csvData = jsPsych.data.get().csv();
          console.log(csvData);
          var formData = {
            exp: "PM_TS",  // comment out for testing
            // exp: "TEST",  // uncomment for testing
            subj: identifier,
            results: csvData
          };
          $.post(
            "http://perfectpitchstudies.pythonanywhere.com/data",
            formData
          ); 
		  $.post(
            "http://svanhedger.pythonanywhere.com/data",
            formData
          ); 
	}	    
};

timeline.push(questionnaireM);

/************************/
/** EXPERIMENT/WRAP-UP **/
/************************/


timeline.push({
  type: 'fullscreen',
  fullscreen_mode: false
});


/*reference ID for mturk */ 
var idcode = {
  type: "html-button-response",
  choices: ['Complete'],
  stimulus: '<p>Thank you for participating. Here is your unique code.</p><p></p>' +
  '<p>' + identifier + '</p>' +
  '<p>Please copy this code before advancing to the next screen! This is what you must enter in MTurk to receive payment.' +
  '<p>Once you have copied this code, press the button to complete the experiment.</p>'
};

timeline.push(idcode);


function saveData(filename, filedata){
   $.ajax({
      type:'post',
      cache: false,
      url: 'write_data.php',
      data: {filename: filename, filedata: filedata}
   });
}


/** tell jsPsych to initialize the timeline variable **/
	jsPsych.init({
        timeline: timeline,
		preload_audio: audio,
        on_finish: function(){ saveData('subj_'+identifier+'.csv', jsPsych.data.get().csv()); }
        
});


	</script>
	</body>
</html>
