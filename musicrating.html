<!DOCTYPE html>
<html>
  <head>
    <title>Music Rating</title>
    <script src="jspsych-6.0.2/jspsych.js"></script>
    <script src="jspsych-6.0.1/plugins/jspsych-html-keyboard-response.js"></script>
	<script src="jspsych-6.0.1/plugins/jspsych-audio-keyboard-response.js"></script>
	<script src="jspsych-6.0.1/plugins/jspsych-html-button-response.js"></script>
	<script src="jspsych-6.0.1/plugins/jspsych-html-slider-response.js"></script>
	<script src="jspsych-6.0.1/plugins/jspsych-image-slider-response.js"></script>
	<script src="jspsych-6.0.1/plugins/jspsych-fullscreen.js"></script>
	<script src="jspsych-6.0.2/plugins/jspsych-survey-text.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <link href="jspsych-6.0.1/css/jspsych.css" rel="stylesheet" type="text/css"></link>
  </head>
  <body></body>
  <script>

 
 /*create timeline */
	  var timeline = [];
	  

/*define subject ID and add it to data output*/	  

var identifier = Math.random().toString(36).substring(7);
jsPsych.data.addProperties({rand_id: identifier});

/*define welcome message trial */
	  var welcome = {
		  type: "html-keyboard-response",
		  stimulus: "Welcome to the experiment. Press any key to begin."
	  };

	  timeline.push(welcome);
	  
/* enter fullscreen mode */
timeline.push({
  type: 'fullscreen',
  fullscreen_mode: true
});

/*instructions*/
	  var instructions = {
  		type: "html-keyboard-response",
  		stimulus: "<p>In the following exercise, you will listen to several short melodies.</p>" +
				  "<p>There are seven melodies in total.</p>" +
		 "<p>After each melody, you will rate the melody on a few adjectives.  You will also be asked how much you like the melody.</p>"+
		 "<p>When you are ready to begin, please press spacebar to advance to the next screen.</p>",
		  choices: [' '],
		  post_trial_gap: 250
						};
						
		timeline.push(instructions);


var audio = ['melody/1_1.mp3', 'melody/1_2.mp3', 'melody/1_3.mp3', 'melody/1_4.mp3', 'melody/1_5.mp3', 'melody/1_6.mp3','melody/1_7.mp3',
'melody/2_1.mp3','melody/2_2.mp3','melody/2_3.mp3','melody/2_4.mp3','melody/2_5.mp3','melody/2_6.mp3','melody/2_7.mp3',
'melody/3_1.mp3','melody/3_2.mp3','melody/3_3.mp3','melody/3_4.mp3','melody/3_5.mp3','melody/3_6.mp3','melody/3_7.mp3',
'melody/4_1.mp3','melody/4_2.mp3','melody/4_3.mp3','melody/4_4.mp3','melody/4_5.mp3','melody/4_6.mp3','melody/4_7.mp3',
'melody/5_1.mp3','melody/5_2.mp3','melody/5_3.mp3','melody/5_4.mp3','melody/5_5.mp3','melody/5_6.mp3','melody/5_7.mp3',
'melody/6_1.mp3','melody/6_2.mp3','melody/6_3.mp3','melody/6_4.mp3','melody/6_5.mp3','melody/6_6.mp3','melody/6_7.mp3',
'melody/7_1.mp3','melody/7_2.mp3','melody/7_3.mp3','melody/7_4.mp3','melody/7_5.mp3','melody/7_6.mp3','melody/7_7.mp3'
			];
			

		
		
		
/* define sound array */		
		  var sounds = [
		  {minor_100:'melody/1_1.mp3', minor_7:'melody/1_2.mp3', minor_75:'melody/1_3.mp3', minor_50: 'melody/1_4.mp3', minor_25: 'melody/1_5.mp3', minor_0: 'melody/1_6.mp3', major_7: 'melody/1_7.mp3'},
		  {minor_100:'melody/2_1.mp3', minor_7:'melody/2_2.mp3', minor_75:'melody/2_3.mp3', minor_50: 'melody/2_4.mp3', minor_25: 'melody/2_5.mp3', minor_0: 'melody/2_6.mp3', major_7: 'melody/2_7.mp3'},
		  {minor_100:'melody/3_1.mp3', minor_7:'melody/3_2.mp3', minor_75:'melody/3_3.mp3', minor_50: 'melody/3_4.mp3', minor_25: 'melody/3_5.mp3', minor_0: 'melody/3_6.mp3', major_7: 'melody/3_7.mp3'},
		  {minor_100:'melody/4_1.mp3', minor_7:'melody/4_2.mp3', minor_75:'melody/4_3.mp3', minor_50: 'melody/4_4.mp3', minor_25: 'melody/4_5.mp3', minor_0: 'melody/4_6.mp3', major_7: 'melody/4_7.mp3'},
		  {minor_100:'melody/5_1.mp3', minor_7:'melody/5_2.mp3', minor_75:'melody/5_3.mp3', minor_50: 'melody/5_4.mp3', minor_25: 'melody/5_5.mp3', minor_0: 'melody/5_6.mp3', major_7: 'melody/5_7.mp3'},
		  {minor_100:'melody/6_1.mp3', minor_7:'melody/6_2.mp3', minor_75:'melody/6_3.mp3', minor_50: 'melody/6_4.mp3', minor_25: 'melody/6_5.mp3', minor_0: 'melody/6_6.mp3', major_7: 'melody/6_7.mp3'},
		  {minor_100:'melody/7_1.mp3', minor_7:'melody/7_2.mp3', minor_75:'melody/7_3.mp3', minor_50: 'melody/7_4.mp3', minor_25: 'melody/7_5.mp3', minor_0: 'melody/7_6.mp3', major_7: 'melody/7_7.mp3'}
		  ];
		  
/* randomize and split that array */			  
		  var soundsrandom = jsPsych.randomization.repeat(sounds, 1);

		  var sounds1 = soundsrandom.slice(0, 1);
		  var sounds2 = soundsrandom.slice(1, 2);
		  var sounds3 = soundsrandom.slice(2, 3);
		  var sounds4 = soundsrandom.slice(3, 4);
		  var sounds5 = soundsrandom.slice(4, 5);
		  var sounds6 = soundsrandom.slice(5, 6);
		  var sounds7 = soundsrandom.slice(6, 7);
		


/* define the music presentation trials */		
var minor_100 = {
	type: "audio-keyboard-response",
	stimulus: jsPsych.timelineVariable('minor_100'),
	choices: jsPsych.NO_KEYS,
	trial_ends_after_audio: true,
	data: {harmony: 'minor_100'}
       };
			  
 var minor_7 = {
 	type: "audio-keyboard-response",
	stimulus: jsPsych.timelineVariable('minor_7'),
	choices: jsPsych.NO_KEYS,
	trial_ends_after_audio: true,
	data: {harmony: 'minor_7'}
		};
				  
var minor_75 = {
	type: "audio-keyboard-response",
	stimulus: jsPsych.timelineVariable('minor_75'),
	choices: jsPsych.NO_KEYS,
	trial_ends_after_audio: true,
	data: {harmony: 'minor_75'}
	   		};  
			
var minor_50 = {
	type: "audio-keyboard-response",
	stimulus: jsPsych.timelineVariable('minor_50'),
	choices: jsPsych.NO_KEYS,
	trial_ends_after_audio: true,
	data: {harmony: 'minor_50'}
		   	};

var minor_25 = {
	type: "audio-keyboard-response",
	stimulus: jsPsych.timelineVariable('minor_25'),
	choices: jsPsych.NO_KEYS,
	trial_ends_after_audio: true,
	data: {harmony: 'minor_25'}
			};
			
var minor_0 = {
	type: "audio-keyboard-response",
	stimulus: jsPsych.timelineVariable('minor_0'),
	choices: jsPsych.NO_KEYS,
	trial_ends_after_audio: true,
	data: {harmony: 'minor_0'}
			};

var major_7 = {
	type: "audio-keyboard-response",
	stimulus: jsPsych.timelineVariable('major_7'),
	choices: jsPsych.NO_KEYS,
	trial_ends_after_audio: true,
	data: {harmony: 'major_7'}
			};


/* Define Rating Trials */

var bittersweet = {
	type: "image-slider-response",
	prompt: "<p> </p>",
	stimulus: "melody/bittersweet2.jpg",
	labels: ['not at all', 'slightly', 'moderately', 'extremely'],
	response_ends_trial: true, 
	data: {term: 'bittersweet'}
				};

var sorrow = {
	type: "image-slider-response",
	prompt: "<p> </p>",
	stimulus: "melody/sorrow2.jpg",
	labels: ['not at all', 'slightly', 'moderately', 'extremely'],
	response_ends_trial: true,
	data: {term: 'sorrow'}
				};				
				
var joy = {
	type: "image-slider-response",
	prompt: "<p> </p>",
	stimulus: "melody/joy2.jpg",
	labels: ['not at all', 'slightly', 'moderately', 'extremely'],
	response_ends_trial: true,
	data: {term: 'joy'}
				};
				
var nostalgia = {
	type: "image-slider-response",
	prompt: "<p> </p>",
	stimulus: "melody/nostalgia2.jpg",
	labels: ['not at all', 'slightly', 'moderately', 'extremely'],
	response_ends_trial: true,
	data: {term: 'nostalgia'}
				};

/* define liking trial separately (always comes at the end of the procedure */

var liking = {
	type: "image-slider-response",
	stimulus: "melody/blank2.jpg",
	prompt: "<p>How much did you <em>like</em> the melody?</p>",
	labels: ['not at all', 'slightly', 'moderately', 'extremely'],
	response_ends_trial: true,
	data: {term: 'liking'}
				};
	
		
/* ****************************************************** */				
/* define the procedures for the different harmonizations */
/* ****************************************************** */		

var ratings = [joy, bittersweet, sorrow, nostalgia];

/* shuffle orderings of the four terms */
var shuffled_ratings1 = jsPsych.randomization.shuffle(ratings);
var shuffled_ratings2 = jsPsych.randomization.shuffle(ratings);
var shuffled_ratings3 = jsPsych.randomization.shuffle(ratings);
var shuffled_ratings4 = jsPsych.randomization.shuffle(ratings);
var shuffled_ratings5 = jsPsych.randomization.shuffle(ratings);
var shuffled_ratings6 = jsPsych.randomization.shuffle(ratings);
var shuffled_ratings7 = jsPsych.randomization.shuffle(ratings);

var like = [liking];

var mi100 = [minor_100];
var mi7 = [minor_7];
var mi75 = [minor_75];
var mi50 = [minor_50];
var mi25 = [minor_25];
var mi0 = [minor_0];
var ma7 = [major_7];

/* concatenate the arrays to create procedures */

var proc_mi100 = mi100.concat(shuffled_ratings1, liking);
var proc_mi7 = mi7.concat(shuffled_ratings2, liking);
var proc_mi75 = mi75.concat(shuffled_ratings3, liking);
var proc_mi50 = mi50.concat(shuffled_ratings4, liking);
var proc_mi25 = mi25.concat(shuffled_ratings5, liking);
var proc_mi0 = mi0.concat(shuffled_ratings6, liking);
var proc_ma7 = ma7.concat(shuffled_ratings7, liking);
	
/* ******************************************************** */
	
var procedure_minor_100 = {
		timeline: proc_mi100,
		timeline_variables: sounds1
			    };
				
var procedure_minor_7 = {
		timeline: proc_mi7,
		timeline_variables: sounds2
				 };
				 
var procedure_minor_75 = {
		timeline: proc_mi75,
		timeline_variables: sounds3
				};
						
var procedure_minor_50 = {
		timeline: proc_mi50,
		timeline_variables: sounds4
				 };
				 
var procedure_minor_25 = {
		timeline: proc_mi25,
		timeline_variables: sounds5
				 };
				 
var procedure_minor_0 = {
		timeline: proc_mi0,
		timeline_variables: sounds6
				 };
				 
var procedure_major_7 = {
		timeline: proc_ma7,
		timeline_variables: sounds7
				 };

/*****************************************************/


/* put all procedures together and shuffle them */				 
var trials = [
				 				procedure_minor_100,
				 				procedure_minor_7,
				 				procedure_minor_75,
				 				procedure_minor_50,
				 				procedure_minor_25,
				 				procedure_minor_0,
								procedure_major_7];
	
	
	
var shuffled_trials = jsPsych.randomization.shuffle(trials);
	
var block_structure = {
		timeline: shuffled_trials
		};	

timeline.push(block_structure);

/* ************************************************ */	
/* Basic Musical Experience / Demographic Questions */
/* ************************************************ */	

var interim = {
  type: "html-keyboard-response",
  stimulus: "Thank you for your responses. Press any key to continue."
};

timeline.push(interim);


var qD = {
  type: 'survey-text',
  questions: [{prompt: "How old are you (in years)?"}, {prompt: "What is your gender?"} ],
  preamble: ['Please answer the following questions to the best of your ability.']
};

timeline.push(qD);


var qM = {
  type: 'survey-text',
  questions: [{prompt: 'Have you ever played a musical instrument, including vocal training? (Y/N)'}, 
			  {prompt: 'Do you consider yourself a musician? (Y/N)'}
			  ],
  preamble: ['Please answer the following questions to the best of your ability.'] 
};

timeline.push(qM);


/** exit fullscreen **/
timeline.push({
  type: 'fullscreen',
  fullscreen_mode: false
});


var qE = {
  type: 'survey-text',
  questions: [{prompt: 'Joyful'}, 
			  {prompt: 'Sorrowful'},
			  {prompt: 'Nostalgic'}, 
			  {prompt: 'Bittersweet'}
			  ],
  preamble: ['<p>In this study, you assessed the extent to which each melody was <em>joyful</em>, <em>sorrowful</em>, <em>nostalgic</em>, and <em>bittersweet</em>.</p>' +
'<p>Using the space provided below, list a single piece of music (outside of this study) that you most strongly associate with each term.</p>' +
'<p>Please try to be as specific as possible (providing artist/composer and/or song title, if possible). You are allowed to search the internet to find song details if necessary.</p>'],
  on_finish: function () {
          var csvData = jsPsych.data.get().csv();
          console.log(csvData);
          var formData = {
            exp: "TEST",  // comment out for testing
            // exp: "TEST",  // uncomment for testing
            subj: identifier,
            results: csvData
          };
          $.post(
            "http://perfectpitchstudies.pythonanywhere.com/data",
            formData
          ); 
		  $.post(
            "http://svanhedger.pythonanywhere.com/data",
            formData
          ); 
	}	  
};

timeline.push(qE);




/*reference ID for mturk */ 
var idcode = {
  type: "html-button-response",
  choices: ['Complete'],
  stimulus: '<p>Thank you for participating. Here is your unique code.</p><p></p>' +
  '<p>' + identifier + '</p>' +
  '<p>Please copy this code before advancing to the next screen! This is what you must enter in MTurk to receive payment.' +
  '<p>Once you have copied this code, press the button to complete the experiment.</p>'
};

timeline.push(idcode);


/* simple php to write the data to the server */ 
function saveData(filename, filedata){
   $.ajax({
      type:'post',
      cache: false,
      url: 'write_data.php',
      data: {filename: filename, filedata: filedata}
   });
}



/*start experiment */ 
	  jsPsych.init ({
		  timeline: timeline,
		  on_finish: function(){ saveData('subj_'+identifier+'.csv', jsPsych.data.get().csv()); },
		  preload_audio: audio

	  })
	  </script>
	  



</html>